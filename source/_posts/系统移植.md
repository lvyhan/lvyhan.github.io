---
title: 系统移植
top: false
cover: false
toc: true
mathjax: false
date: 2023-05-23 09:29:28
tags:
author: lvyhan
img: medias/featureimages/0.jpg
password:
summary:
categories:
---

# 操作系统的基本知识

**操作系统的五大功能**：处理器管理，存储器管理，作业管理，设备管理，文件管理

**处理器管理**：处理器管理最基本的功能是处理中断事件；处理器只能发现中断事件并产生中断而并不能进行处理，配置操作系统后就可对各种事件进行处理，处理器管理的另一功能是处理器调度，根据不同情况进行调度

**存储器管理**：即对内存处理器的管理：分配内存空间，保证各作业占用的存储空间不发生矛盾，并不互相干扰

**作业管理**：每个用户请求系统完成的一个独立的操作称为作业；作业管理是对用户提交的诸多作业进行管理，包括作业的组织、控制、调度等，以尽可能的高效利用系统资源

**设备管理**：负责管理各类外围设备，包括分配、启动、故障处理等。当用户使用外部设备时，必须提出请求，待操作系统进行分配后方可使用

​		操作系统中设备管理的功能：

​				1、缓冲管理：缓解CPU和I/O设备速度不匹配的矛盾，提高CPU和I/O的设备利用率，通常为设置缓冲区

​				2、设备分配：根据用户的I/O请求，分配所需的设备；若I/O设备与CPU之间存在设备控制器和通道，还需为设备分配相对应的控制器和通道

​				3、设备处理：设备处理程序又称设备驱动程序，基本任务是实现CPU和设备控制器之间的通信

​				4、设备独立性和虚拟设备：用户向系统申请和使用的设备与实际操作的设备无关

**文件管理**：操作系统对信息资源的管理。操作系统中，将负责存取的管理信息的部分称为文件系统。文件是在逻辑上具有完整意义的一组相关信息的有序集合。文件管理支持文件的存储、检索、修改等操作以及文件的保护功能。

# 系统移植

系统移植，即根据demo板进行的删改开发的新板子，将demo板的操作系统根据删改移植到新板子

系统移植分为uboot移植和kernel移植

## **环境搭建：**tftp、nfs

### 		**tftp：** tiny ftp，迷你文件传输协议

​				    sudo apt-get install tfptd-hpa tftp-hpa；mkdir /tftpboot；chmod 777 /tftpboot；

​					修改配置文件：sudo vi /etc/default/tftpd-hpa

​												TFTP_USERNAME="tftp"

​												TFTP_DIRECTORY="/tftpboot"

​												TFTP_ADDRESS="0.0.0.0:69"

​												TFTP_OPTIONS="-c -s -l"

​					重启：sudo service tftpd-hpa restart

​					测试：客户端在其他目录，登陆：tftp 127.0.0.1；下载：get filename；上传：put filename；退出：quit

### 	  **nfs：** network file system网络文件系统

​				安装：sudo apt-get install nfs-kernel-server

​				配置：配置/etc/exports文件，该文件决定挂载目录及权限；在文件末尾添加：/rootfs *(rw,sync,no_root_squash,no_subtree_check)

​				重启：sudo service nfs-kernel-server restart

​				客户端测试：sudo mount -t nfs 127.0.0.1:/home/ubuntu/rootfs  ./123  取消映射：sudo  mount  ./123

​				若想使用NFS为开发板的文件系统，需要在rootfs目录下解压一个文件系统

## uboot移植

**uboot主要作用：**引导启动操作系统内核、部署计算机系统、操作flash、串口等硬件驱动、提供人机交互界面

**uboot启动大概流程**：分为汇编阶段和C语言阶段；

​		汇编阶段，开机启动uboot，核心硬件设备初始化（设置cpu模式（svc32），关闭看门狗，设置时钟，关闭mmc等），自拷贝（拷贝C语言阶段代码到ram中），设置栈空间

​		C语言阶段：大部分硬件初始化，[选择性进入交互界面]，将内核读取到ram当中，为内核设置参数，调用操作系统

uboot修改，默认bootargs修改在uboot/include/configs下对应板子的.h文件，可以修改默认bootargs

uboot交互界面常用命令：printenv打印环境变量、setenv设置（如set bootcmd tftp 41000000  uImage\; tftp 42000000 exynos4412-fs4412.dtb\; bootm 41000000 - 42000000）、saveenv、boot（启动Linux系统）[U-Boot常用命令](https://blog.csdn.net/qq_46079439/article/details/125474461)

**uboot启动详细流程：**

uboot属于两阶段的BootLoader，即汇编阶段与C语言阶段

​		汇编阶段文件为arch/arm/cpu/下对应cpu的start.S和board/目录下对应板子的lowlevel_init.S，前者是平台相关代码，后者为开发板对应代码；主要完成一些依赖于cpu体系结构的初始化，并调用C语言阶段代码

​		C语言阶段代码文件为arch/arm/lib/board.c里边会调用board/目录下对应板子的c文件的函数进行硬件初始化等;即一般在这里添加一些功能

#### 编译移植

**编译**：uboot顶层目录

​			配置：make  板子名字_config ARCH=arm CROSS_COMPILE=arm-none-linux-gnueabi-

​			编译：make ARCH=arm CROSS_COMPILE=arm-none-linux-gnueabi-；顶层目录生成烧录文件u-boot.bin

​			清理：make distclean

**移植：**uboot顶层目录，以origen为例

​			移植板级代码：cp board/samsung/origen board/samsung/fs4412 -a

​									   cd board/samsung/origen board/samsung/fs4412
​									   mv origen.c fs4412.c
​									   vim  Makefile,将origen替换为fs4412

​			拷贝配置文件：cp include/configs/origen.h include/configs/fs4412.h

​			增加板子配置：vi board.cfg 模仿origen编写fs4412

​			编译

## 内核编译

**内核源码分类：**

​		1、平台相关：

​						cpu：arch

​						板子：设备树（以树形结构记录板级设备信息的文件dts）arch/arm/boot/dts/

​						配置：arch/arm/configs

​		2、平台无关：

​					Documentation-文档   init-初始化代码     lib: 内核独有精简C库        README          sound
​					block-块设备框架      drivers-驱动     ipc-进程间通信     MAINTAINERS  REPORTING-BUGS  tools
​					COPYING  firmware       Kbuild   Makefile     samples         usr
​					CREDITS  fs:文件系统的支持             Kconfig  mm:内存管理     scripts         virt
​					crypto   include: 头文件        kernel-核心实现   net-网络协议          security-加密安全算法

**编译**：顶层目录

​			1、配置 ：cp arch/arm/configs/exynos_defconfig   .config //拷贝需要编译的板子配置信息到顶层目录并重命名为.config

​								make menuconfig  ARCH=arm //配置内核功能，裁剪内核

​			2、编译：@@make ARCH=arm CROSS_COMPILE=arm-none-linux-gnueabi-  		生成zImage 
​						  make  uImage  ARCH=arm CROSS_COMPILE=arm-none-linux-gnueabi-  	生成uImage 

​						  生成uImage需要拷贝u-boot编译后生成的mkimage工具：sudo cp tools/mkimage /bin

​			3、生成的在arch/arm/boot/下:

​							Image  内核二进制文件，可直接运行

​							zImage  对Image进行的压缩，运行需先解压，自带解压程序

​							uImage  u-boot专用Image

​			4、清除：make distclean清除全部配置 make clean保留.config

单独编译设备树：make dtbs ARCH=arm CROSS_COMPILE=arm-none-linux-gnueabi-

## 文件系统制作

ramdisk，buildroot

ramdisk文件系统，掉电丢失，读写速度快，安全性高，自2.6以后就开始淘汰；//可挂载flash，来存储到硬盘上使用

ramdisk是使用内存模拟一个块设备，需要一个文件系统来组织数据，还需要格式化为如ext2或其他文件系统格式

buildroot是制作根文件系统的工具，拥有图形化界面配置

**制作ramdisk文件系统**

1、制作8m的镜像文件：dd   if=/dev/zero  of=ramdisk   bs=1k   count=8192

2、格式化为ext2文件格式：mkfs.ext2   -F   ramdisk

3、创建目录作为挂载点：sudo mkdir /mnt/initrd

4、挂载镜像文件：sudo mount -t   ext2  ramdisk  /mnt/initrd

5、复制解压的根文件系统（VFS文件夹解压测试好的文件系统）：sudo cp   VFS/rootfs/*   /mnt/initrd  -a

6、卸载initrd ：sudo umount  /mnt/initrd

7、压缩ramdisk为ramdisk.gz：gzip  --best  -c  ramdisk  >   ramdisk.gz

8、格式化为uboot可识别格式：mkimage -n "ramdisk" -A arm -O linux -T ramdisk -C gzip -d ramdisk.gz ramdisk.img

ramdisk.img即为制作好的ramdisk文件系统

**配置内核支持ramdisk：**

​		make menuconfig

​		Device  Drivers

​				Block  device --->

​								<*>RAM  block device  support

​								(8192) Default RAM disk size (kbytes)  **(修改为8M)**

​		General setup --->

​								[*] Initial RAM filesystem and RAM disk (initramfs/initrd) support

**ramdisk启动：**

进入u-boot交互模式

1、下载os到ram

​		tftp 41000000 uImage

​		movi  write kernel  41000000

2、下载dtb 到ram

​		tftp  41000000 exynos4412-fs4412.dtb

​		movi write dtb 41000000

3、下载文件系统到ram

​		tftp 41000000 ramdisk.img
​						Bytes transferred = 2544147 (26d213 hex)
​		movi write rootfs 41000000  26d213

4、修改bootcmd 
		set bootcmd   movi read kernel 41000000\;movi read dtb 42000000\;movi read rootfs 43000000 26d213\;bootm 41000000 43000000 42000000
		set  bootargs  root=/dev/ram0  rw console=ttySAC2,115200 init=/linuxrc

**buildroot:**[【buildroot】buildroot使用笔记-01 | 常规使用步骤_iriczhao的博客-CSDN博客](https://blog.csdn.net/iriczhao/article/details/127622954)

开机启动:  
		在 /etc/init.d/rcS	 加入你的启动程序
